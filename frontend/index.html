<head>
    <script src="libs/flyd-cbb5aec.js"></script>
    <script src="libs/seview-2.0.5-unpkg.js"></script>
    <script src="libs/mithril-2.2.2.js"></script>
    <script src="libs/patchinko-immutable-dcb7859.js"></script>
    <script src="importEnv.js"></script>
    <script src="importSeviewMithril.js"></script>
    <script src="importExchange.js"></script>
    <script src="importRenderStream.js"></script>
    <script src="views/importChatRoomView.js"></script>
    <script src="views/importChatRoomSelectionView.js"></script>
</head>
<body>

    <h1>Hi</h1>
    <div id="room-container"></div>
    <div id="chat-container"></div>

    <script>
        function logk(k, v) {
            console.log(k, v);
            return v;
        }
        const seviewMithril = importSeviewMithril(m);
        const h = seview.seview(seviewMithril);

        function buildUrl(protocol, host, port, path) {
            return `${protocol}://${host}:${port}/` + path.join('/');
        }
        const env = importEnv();

        const initialState = {
          chat: {
            selectedRoom: 'room1_uuid',
            rooms: {
              room1_uuid: {
                name: 'room1',
                messages: [],
              },
            },
          },
        };
        const { updateState, stream } = importRenderStream(
            flyd,
            initialState);
        const commonImportArgs = {
            flyd,
            updateState,
        };
        const routes = [
            ['/', 'index', importChatRoomView],
            ['/channels', 'channels', importChatRoomSelectionView],
        ];
        const routedViews = routes.map(([path, urlName, importView]) =>
            [path, urlName, importView(commonImportArgs)]);

        const exchangeLib = importExchange({ window });
        const exchangePromise = new Promise(resolve => {
            const exchange = exchangeLib.init(
                buildUrl(env.WS_PROTOCOL, env.WS_HOST, env.WS_PORT, ['FAKE_SESSION_UUID']),
                {
                    onOpen() {
                        resolve(exchange);
                    },
                    onMessage(obj) {
                        // check type of message
                        if (obj.data === 'pong') {
                            return;
                        } else if (obj.data.startsWith('chat')) {
                            // chat|room1_uuid|msgcontent
                            // just get the message
                            const messageContent = obj.data.split('|')[2];
                            console.log('ob', obj);
                            updateState(state => O(state, {
                                chat: O({
                                    rooms: O({
                                        [state.chat.selectedRoom]: O({
                                            messages: O(list => list.concat([messageContent])),
                                        }),
                                    }),
                                }),
                            }));
                        }
                    },
                });
        });
        exchangePromise.then(exchange => {
            exchange.joinChat(initialState.chat.selectedRoom);

            stream.map(state => {
                console.log('state', state);
                m.render(
                    document.getElementById('chat-container'),
                    h(routedViews[0][2].render({ state, exchange })));
                m.render(
                    document.getElementById('room-container'),
                    h(routedViews[1][2].render({ state, exchange })));
            });

        });
    </script>
</body>
