<head>
    <script src="libs/flyd-cbb5aec.js"></script>
    <script src="libs/seview-2.0.5-unpkg.js"></script>
    <script src="libs/mithril-2.2.2.js"></script>
    <script src="libs/patchinko-immutable-dcb7859.js"></script>
    <script src="importEnv.js"></script>
    <script src="importSeviewMithril.js"></script>
    <script src="importExchange.js"></script>
    <script src="importRenderStream.js"></script>
    <script src="views/importChatRoomView.js"></script>
</head>
<body>
    <script>
        function logk(k, v) {
            console.log(k, v);
            return v;
        }
        const seviewMithril = importSeviewMithril(m);
        const h = seview.seview(seviewMithril);

        function buildUrl(protocol, host, port, path) {
            return `${protocol}://${host}:${port}/` + path.join('/');
        }
        const env = importEnv();

        const initialState = {
          chat: {
            selectedRooms: ['room1_uuid'],
            messages: [],
          },
        };
        const { updateState, stream } = importRenderStream(
            flyd,
            initialState);
        const commonImportArgs = {
            flyd,
            updateState,
        };
        const routes = [
            ['/', 'index', importChatRoomView],
        ];
        const routedViews = routes.map(([path, urlName, importView]) =>
            [path, urlName, importView(commonImportArgs)]);

        const exchangeLib = importExchange({ window });
        const exchangePromise = new Promise(resolve => {
            const exchange = exchangeLib.init(
                buildUrl(env.WS_PROTOCOL, env.WS_HOST, env.WS_PORT, ['FAKE_SESSION_UUID']),
                {
                    onOpen() {
                        resolve(exchange);
                    },
                    onMessage(obj) {
                        console.log('ob', obj);
                        updateState(state => O(state, {
                            chat: O({
                                messages: O(list => list.concat([obj.data])),
                            }),
                        }));
                    },
                });
        });
        exchangePromise.then(exchange => {
            exchange.joinChat(initialState.chat.selectedRooms[0]);

            stream.map(state => {
                m.render(
                    document.body,
                    h(routedViews[0][2].render({ state, exchange })));
              });
        });
    </script>
</body>
