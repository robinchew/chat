<head>
    <script src="importEnv.js"></script>
</head>
<body>
    <ul id="messages">
    </ul>
    <input id="type_here" />
    <script>
        function buildUrl(protocol, host, port, path) {
            return `${protocol}://${host}:${port}/` + path.join('/');
        }
        const env = importEnv();
        const ws = new WebSocket(buildUrl(env.WS_PROTOCOL, env.WS_HOST, env.WS_PORT, ['FAKE_SESSION_UUID']));
        const messages = document.getElementById('messages');

        function subscribe() {
            ws.send('subscribe');
        }
        function joinChat(chatName) {
            ws.send(['chat', chatName, 'join'].join('|'));
        }
        function sendMessage(chatName, message) {
            ws.send(['chat', chatName, 'message', message].join('|'));
        }
        function renderMessage(message) {
            const li = document.createElement('li')
            li.innerHTML = message;
            messages.appendChild(li);
        }

        const roomName = 'room1_UUID';

        ws.onopen = () => {
            subscribe();
            joinChat(roomName);
            setInterval(
                () => { ws.send('ping') },
                1000 * 55);
        };
        ws.onclose = () => {
            renderMessage('<span style="color:red">Connection closed</span>');
        }
        ws.onmessage = (d) => {
            renderMessage(d.data);
        }

        const input = document.getElementById('type_here');
        input.focus();
        input.addEventListener('keyup', e => {
            if (e.key === 'Enter') {
                sendMessage(roomName, e.currentTarget.value);
                e.currentTarget.value = '';
            }
        });
    </script>
</body>
