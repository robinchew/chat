<head>
    <script src="libs/flyd-cbb5aec.js"></script>
    <script src="libs/ramda-0.29.1.js"></script>
    <script src="libs/seview-2.0.5-unpkg.js"></script>
    <script src="libs/mithril-2.2.2.js"></script>
    <script src="libs/patchinko-immutable-dcb7859.js"></script>
    <script src="importEnv.js"></script>
    <script src="importRoutes.js"></script>
    <script src="importSeviewMithril.js"></script>
    <script src="importExchange.js"></script>
    <script src="importRenderStream.js"></script>
    <script src="views/importChatRoomView.js"></script>
    <script src="views/importExampleView.js"></script>
</head>
<body>
    <script>
        function logk(k, v) {
            console.log(k, v);
            return v;
        }
        const seviewMithril = importSeviewMithril(m);
        const h = seview.seview(seviewMithril);

        function buildUrl(protocol, host, port, path) {
            return `${protocol}://${host}:${port}/` + path.join('/');
        }
        const env = importEnv();
        const routeLib = importRoutes({ patchinko: O, ramda: R, window });

        const initialState = {
          chat: {
            selectedRooms: ['room1_uuid'],
            messages: [],
          },
        };
        const { updateState, stream } = importRenderStream(
            flyd,
            initialState);
        const commonImportArgs = {
            flyd,
            updateState,
        };
        const routes = [
            ['/', 'index', importChatRoomView],
            ['/example', 'example', importExampleView],
            ['/example/:num/egg/:val', 'example2', importExampleView],
        ];
        const routedViews = routes.map(([path, urlName, importView]) =>
            [path, urlName, importView(commonImportArgs)]);

        const { changeView, getCurrentRoute } = routeLib.init(routedViews, { hash: true })

        const [[, urlName], params] = getCurrentRoute();
        updateState(changeView(urlName, params));

        const exchangeLib = importExchange({ window });
        const exchangePromise = new Promise(resolve => {
            const exchange = exchangeLib.init(
                buildUrl(env.WS_PROTOCOL, env.WS_HOST, env.WS_PORT, ['FAKE_SESSION_UUID']),
                {
                    onOpen() {
                        resolve(exchange);
                    },
                    onMessage(obj) {
                        // check type of message
                        if (obj.data === 'pong') {
                            return;
                        } else if (obj.data.startsWith('chat')) {
                            // chat|room1_uuid|msgcontent
                            // just get the message
                            const messageContent = obj.data.split('|')[2];
                            updateState(state => O(state, {
                                chat: O({
                                    messages: O(list => list.concat([messageContent])),
                                }),
                            }));
                        }
                    },
                });
        });
        exchangePromise.then(exchange => {
            exchange.joinChat(initialState.chat.selectedRooms[0]);

            stream.map(state => {
                m.render(
                    document.body,
                    h(state.view.render({ state, exchange })));
              });
        });
    </script>
</body>
